name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ main ]  # یا master

jobs:
  lint_typecheck_build:
    name: Lint / Typecheck / Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Lint (CI)
        run: npm run lint:ci

      - name: Build
        run: npm run build

  docs_sync:
    name: Docs Sync (ensure docs:all produces no unstaged changes)
    runs-on: ubuntu-latest
    needs: lint_typecheck_build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run docs:all
        run: npm run docs:all

      - name: Ensure no diff after docs:all
        run: |
          # show status for debugging
          git status --porcelain
          # if docs:all modified files, git diff will be non-empty -> exit non-zero
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Docs generated changes after running npm run docs:all. Please run 'npm run docs:all' locally and commit the updated artifacts (app-tree.txt, components-tree.txt, docs injection) before creating the PR."
            git --no-pager status --porcelain
            git --no-pager diff
            exit 1
          fi
